name: Deploy to Azure Container Apps (DISABLED)

# ⚠️ DISABLED - Using deploy-aci.yml instead
# Container Apps doesn't work well with databases (TCP)

on:
  workflow_dispatch: # Solo manual, deshabilitado el push automático

env:
  AZURE_CONTAINER_ENVIRONMENT: "kallpa-futbol-env" # Tu Container Apps Environment
  RESOURCE_GROUP: "kallpa-futbol-rg" # Tu Resource Group
  LOCATION: "westus3" # West US 3

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: axlmd/backend-futbol:${{ github.sha }},axlmd/backend-futbol:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 1. Crear/Actualizar MariaDB Container App
      - name: Deploy MariaDB
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: mariadb
          containerAppEnvironment: ${{ env.AZURE_CONTAINER_ENVIRONMENT }}
          targetPort: 3306
          ingress: internal
          disableIngress: false
          imageToDeploy: mariadb:11
          environmentVariables: |
            MARIADB_ROOT_PASSWORD=${{ secrets.MARIADB_ROOT_PASSWORD }}
            MARIADB_DATABASE=sportDB
            MARIADB_USER=desarrollo
            MARIADB_PASSWORD=${{ secrets.MARIADB_PASSWORD }}
            MARIADB_ALLOW_EMPTY_ROOT_PASSWORD=no

      # 2. Crear/Actualizar PostgreSQL Container App
      - name: Deploy PostgreSQL
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: postgres-db
          containerAppEnvironment: ${{ env.AZURE_CONTAINER_ENVIRONMENT }}
          targetPort: 5432
          ingress: internal
          disableIngress: false
          imageToDeploy: postgres:15
          environmentVariables: |
            POSTGRES_USER=ci_user
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=futbol_prod_db

      # Esperar a que las bases de datos estén listas
      - name: Wait for databases to be ready
        run: sleep 60

      # 3. Crear/Actualizar Users Microservice
      - name: Deploy Users MS
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: users-ms
          containerAppEnvironment: ${{ env.AZURE_CONTAINER_ENVIRONMENT }}
          targetPort: 8096
          ingress: internal
          imageToDeploy: joseguaman1/users-docker:v1
          environmentVariables: |
            SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb.internal.${{ env.AZURE_CONTAINER_ENVIRONMENT }}.westus3.azurecontainerapps.io:3306/sportDB
            SPRING_DATASOURCE_USERNAME=desarrollo
            SPRING_DATASOURCE_PASSWORD=${{ secrets.MARIADB_PASSWORD }}
            SERVER_PORT=8096

      # 4. Crear/Actualizar Backend Principal
      - name: Deploy Backend Futbol
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: backend-futbol
          containerAppEnvironment: ${{ env.AZURE_CONTAINER_ENVIRONMENT }}
          targetPort: 8000
          ingress: external
          imageToDeploy: axlmd/backend-futbol:${{ github.sha }}
          environmentVariables: |
            DB_HOST=postgres-db.internal.${{ env.AZURE_CONTAINER_ENVIRONMENT }}.westus3.azurecontainerapps.io
            DB_PORT=5432
            DB_USER=ci_user
            DB_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            DB_NAME=futbol_prod_db
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            PERSON_MS_BASE_URL=http://users-ms.internal.${{ env.AZURE_CONTAINER_ENVIRONMENT }}.westus3.azurecontainerapps.io:8096
            ALLOWED_ORIGINS=["http://localhost:3000","http://localhost:5173"]
            FRONTEND_URL=http://localhost:5173
