apiVersion: '2021-10-01'
location: westus3
name: kallpa-futbol-group
properties:
  osType: Linux
  restartPolicy: Always
  ipAddress:
    type: Public
    dnsNameLabel: kallpa-futbol-api
    ports:
      - protocol: TCP
        port: 8000
  containers:
    # 1. PostgreSQL Database
    - name: postgres-db
      properties:
        image: postgres:15
        resources:
          requests:
            cpu: 0.5
            memoryInGB: 1
        ports:
          - port: 5432
        environmentVariables:
          - name: POSTGRES_USER
            value: ci_user
          - name: POSTGRES_PASSWORD
            secureValue: ${POSTGRES_PASSWORD}
          - name: POSTGRES_DB
            value: futbol_prod_db

    # 2. MariaDB Database
    - name: mariadb
      properties:
        image: mariadb:11
        resources:
          requests:
            cpu: 0.5
            memoryInGB: 1
        ports:
          - port: 3306
        environmentVariables:
          - name: MARIADB_ROOT_PASSWORD
            secureValue: ${MARIADB_ROOT_PASSWORD}
          - name: MARIADB_DATABASE
            value: sportDB
          - name: MARIADB_USER
            value: desarrollo
          - name: MARIADB_PASSWORD
            secureValue: ${MARIADB_PASSWORD}

    # 3. Users Microservice
    - name: users-ms
      properties:
        image: joseguaman1/users-docker:v1
        resources:
          requests:
            cpu: 0.5
            memoryInGB: 1
        ports:
          - port: 8096
        environmentVariables:
          - name: SPRING_DATASOURCE_URL
            value: jdbc:mariadb://localhost:3306/sportDB
          - name: SPRING_DATASOURCE_USERNAME
            value: desarrollo
          - name: SPRING_DATASOURCE_PASSWORD
            secureValue: ${MARIADB_PASSWORD}
          - name: SERVER_PORT
            value: "8096"

    # 4. Backend Futbol (Principal)
    - name: backend-futbol
      properties:
        image: axlmd/backend-futbol:${IMAGE_TAG}
        resources:
          requests:
            cpu: 0.5
            memoryInGB: 1
        ports:
          - port: 8000
        environmentVariables:
          - name: DB_HOST
            value: localhost
          - name: DB_PORT
            value: "5432"
          - name: DB_USER
            value: ci_user
          - name: DB_PASSWORD
            secureValue: ${POSTGRES_PASSWORD}
          - name: DB_NAME
            value: futbol_prod_db
          - name: JWT_SECRET
            secureValue: ${JWT_SECRET}
          - name: PERSON_MS_BASE_URL
            value: http://localhost:8096
          - name: ALLOWED_ORIGINS
            value: '["http://localhost:3000","http://localhost:5173","${FRONTEND_URL}"]'
          - name: FRONTEND_URL
            value: ${FRONTEND_URL}
